<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - D Attendance</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <!-- Top Header -->
    <div class="top-header">
        <div class="top-header-left">
            <div class="top-header-logo">D Attendance</div>
        </div>
        <div class="top-header-right">
            <div class="user-menu" onclick="toggleUserMenu(event)">
                <div class="user-avatar">{{ current_user.full_name[0].upper() }}</div>
                <span>{{ current_user.full_name }}</span>
                <span style="margin-left: 5px;">‚ñº</span>
                <div class="user-dropdown">
                    <a href="{{ url_for('profile') }}" class="user-dropdown-item">
                        <span>üë§</span>
                        <span>Profile</span>
                    </a>
                    <a href="{{ url_for('logout') }}" class="user-dropdown-item">
                        <span>üö™</span>
                        <span>Logout</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-menu">
            <a href="{{ url_for('admin_dashboard') }}" class="sidebar-menu-item active">
                <i>üìä</i> Dashboard
            </a>
            <a href="{{ url_for('manage_employees') }}" class="sidebar-menu-item">
                <i>üë•</i> PIM
            </a>
            <a href="{{ url_for('manage_rotas') }}" class="sidebar-menu-item">
                <i>üìÖ</i> Rotas
            </a>
            <a href="{{ url_for('attendance_records') }}" class="sidebar-menu-item">
                <i>‚è∞</i> Attendance
            </a>
            <a href="{{ url_for('reports') }}" class="sidebar-menu-item">
                <i>üìà</i> Reports
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="page-header">
            <h1>Dashboard</h1>
        </div>

        <div class="dashboard-grid">
            <!-- Time at Work Widget -->
            <div class="card">
                <div class="card-header">
                    <h3>Time at Work</h3>
                </div>
                <div class="card-body">
                    <div style="padding: 10px 0;">
                        <div style="max-height: 320px; overflow-y: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead style="position: sticky; top: 0; background: var(--card-bg); z-index: 1;">
                                    <tr style="border-bottom: 1px solid var(--border-color);">
                                        <th style="text-align: left; padding: 10px; font-size: 12px; color: var(--text-secondary); font-weight: 600;">Employee</th>
                                        <th style="text-align: center; padding: 10px; font-size: 12px; color: var(--text-secondary); font-weight: 600;">Hours</th>
                                        <th style="text-align: center; padding: 10px; font-size: 12px; color: var(--text-secondary); font-weight: 600;">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="employee-hours-list">
                                    <tr>
                                        <td colspan="3" style="text-align: center; padding: 20px; color: var(--text-secondary);">
                                            Loading...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Launch Widget -->
            <div class="card">
                <div class="card-header">
                    <h3>Quick Launch</h3>
                </div>
                <div class="card-body quick-launch">
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px 15px; justify-items: center; padding: 15px 20px;">
                        <a href="{{ url_for('add_employee') }}" class="quick-action-btn">
                            <span>‚ûï</span>
                            <span>Add Employee</span>
                        </a>
                        <a href="{{ url_for('attendance_records') }}" class="quick-action-btn">
                            <span>üìã</span>
                            <span>Attendance</span>
                        </a>
                        <a href="{{ url_for('reports') }}" class="quick-action-btn">
                            <span>üìä</span>
                            <span>Reports</span>
                        </a>
                        <a href="{{ url_for('manage_employees') }}" class="quick-action-btn">
                            <span>üë•</span>
                            <span>PIM</span>
                        </a>
                        <a href="{{ url_for('manage_rotas') }}" class="quick-action-btn">
                            <span>üìÖ</span>
                            <span>Rotas</span>
                        </a>
                        <a href="{{ url_for('reports') }}" class="quick-action-btn">
                            <span>üìà</span>
                            <span>Analytics</span>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Employee Distribution Widget -->
            <div class="card">
                <div class="card-header">
                    <h3>Employee Statistics</h3>
                </div>
                <div class="card-body">
                    <div class="stats-grid" style="grid-template-columns: 1fr 1fr 1fr; margin-bottom: 0;">
                        <div style="text-align: center;">
                            <div class="stat-label">Total Employees</div>
                            <div class="stat-value" id="total-employees">{{ total_employees }}</div>
                        </div>
                        <div style="text-align: center;">
                            <div class="stat-label">Present Today</div>
                            <div class="stat-value" id="present-today" style="color: var(--success);">{{ present_today }}</div>
                        </div>
                        <div style="text-align: center;">
                            <div class="stat-label">Absent Today</div>
                            <div class="stat-value" id="absent-today" style="color: var(--danger);">0</div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        function toggleUserMenu(event) {
            event.stopPropagation();
            const menu = event.currentTarget;
            menu.classList.toggle('active');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const userMenus = document.querySelectorAll('.user-menu');
            userMenus.forEach(menu => {
                if (!menu.contains(event.target)) {
                    menu.classList.remove('active');
                }
            });
        });

        function updateStats() {
            fetch('{{ url_for("get_stats") }}')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('total-employees').textContent = data.total_employees;
                    document.getElementById('present-today').textContent = data.present_today;
                    document.getElementById('absent-today').textContent = data.absent_today;
                })
                .catch(error => console.error('Error:', error));
        }

        function updateEmployeeHours() {
            fetch('{{ url_for("get_employee_hours_today") }}')
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('employee-hours-list');
                    
                    if (data.employees.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="3" style="text-align: center; padding: 20px; color: var(--text-secondary);">
                                    No employees found
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    tbody.innerHTML = data.employees.map(emp => {
                        let statusColor = 'var(--text-secondary)';
                        let statusBg = 'transparent';
                        
                        if (emp.status === 'Working') {
                            statusColor = 'var(--success)';
                            statusBg = 'rgba(76, 175, 80, 0.1)';
                        } else if (emp.status === 'Checked Out') {
                            statusColor = 'var(--primary-color)';
                            statusBg = 'rgba(52, 152, 219, 0.1)';
                        } else {
                            statusColor = 'var(--text-secondary)';
                            statusBg = 'rgba(149, 165, 166, 0.1)';
                        }
                        
                        return `
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <td style="padding: 12px 10px; font-size: 13px; color: var(--text-primary);">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 13px;">
                                            ${emp.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2)}
                                        </div>
                                        <span>${emp.name}</span>
                                    </div>
                                </td>
                                <td style="padding: 12px 10px; text-align: center; font-size: 14px; font-weight: 600; color: var(--primary-color);">
                                    ${emp.hours}
                                </td>
                                <td style="padding: 12px 10px; text-align: center;">
                                    <span style="display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 500; color: ${statusColor}; background: ${statusBg};">
                                        ${emp.status}
                                    </span>
                                </td>
                            </tr>
                        `;
                    }).join('');
                })
                .catch(error => console.error('Error:', error));
        }

        updateStats();
        updateEmployeeHours();
        setInterval(updateStats, 30000);
        setInterval(updateEmployeeHours, 30000);
    </script>
</body>
</html>
